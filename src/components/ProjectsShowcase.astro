---
// ProjectsShowcase now loads projects from the `projects` content collection.
// It supports multiple highlighted projects (featured=true). Highlights are
// ordered by `highlightOrder` ascending. The rest are shown in the grid.
// You can pass an optional `limit` prop to limit the number of non-highlighted projects.

import { getCollection } from 'astro:content';
import ProjectCard from './ProjectCard.astro';

type RawProject = {
  id: string;
  data: any;
};

type Project = {
  id: string;
  title: string;
  description: string;
  href: string;
  tags: string[];
  featured: boolean;
  highlightOrder: number;
};

const props = Astro.props as { limit?: number; showAll?: boolean };
const limit: number = props.limit ?? 6;
const showAll: boolean = !!props.showAll;

const all = (await getCollection('projects')) as RawProject[];

// Map entries to a simpler shape and attach id
const mapped: Project[] = all.map((e) => ({
  id: e.id,
  title: e.data.title ?? '',
  description: e.data.description ?? '',
  href: e.data.href ?? '#',
  tags: (e.data.tags ?? []) as string[],
  featured: !!e.data.featured,
  highlightOrder: typeof e.data.highlightOrder === 'number' ? e.data.highlightOrder : 9999,
}));

// Only include featured projects in highlights. Non-featured projects are
// treated as "others" but will only be rendered when `showAll` is true.
const highlights: Project[] = mapped.filter((p) => p.featured).sort((a, b) => a.highlightOrder - b.highlightOrder);
const others: Project[] = mapped.filter((p) => !p.featured).slice(0, limit);

---

<section class="projects">
  <div class="projects__inner">
    <div class="projects__header">
      <h2>Projects</h2>
      <p class="projects__lead">These are some projects I've recently built.</p>
    </div>

    {highlights.length > 0 && (
      <div class="projects__highlights">
        {highlights.map((p) => (
          <ProjectCard project={p} highlight={true} />
        ))}
      </div>
    )}

    {showAll && (
      <div class="projects__grid">
        {others.map((p) => (
          <ProjectCard project={p} />
        ))}
      </div>
    )}
    {!showAll && (
      <div class="projects__cta">
        <a href="/projects" class="btn btn--ghost">View all projects</a>
      </div>
    )}
  </div>

</section>

<style>
  .projects { padding: 0.6rem 0.5rem 1.25rem; }
  .projects__inner { max-width: 760px; margin: 0 auto; padding-top: 0.25rem; }
  .projects__header { text-align: left; margin-bottom: .75rem; }
  .projects__header h2 { margin: 0 0 .25rem 0; }
  .projects__lead { color: rgb(var(--gray-dark)); margin: 0 0 0.5rem 0; max-width: 60ch; }

  .projects__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: .35rem;
  }

  /* CTA row */
  .projects__cta { display: flex; justify-content: center; margin-top: .9rem; }
  .btn { display: inline-flex; align-items: center; justify-content: center; gap: .5rem; padding: .7rem 1rem; border-radius: 10px; border: 1px solid rgba(var(--gray), 0.15); text-decoration: none; font-weight: 600; }
  .btn--ghost { background: rgb(var(--gray-light)); color: rgb(var(--black)); }

  @media (max-width: 640px) {
    .projects__header { text-align: center; }
  }
</style>
