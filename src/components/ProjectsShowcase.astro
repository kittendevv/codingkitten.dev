---
// ProjectsShowcase now loads projects from the `projects` content collection.
// It supports multiple highlighted projects (featured=true). Highlights are
// ordered by `highlightOrder` ascending. The rest are shown in the grid.
// You can pass an optional `limit` prop to limit the number of non-highlighted projects.

import { getCollection } from 'astro:content';
import ProjectCard from './ProjectCard.astro';

type RawProject = {
  id: string;
  data: any;
};

type Project = {
  id: string;
  title: string;
  description: string;
  href: string;
  tags: string[];
  featured: boolean;
  highlightOrder: number;
};

const props = Astro.props as { limit?: number; showAll?: boolean };
const limit: number = props.limit ?? 6;
const showAll: boolean = !!props.showAll;

const all = (await getCollection('projects')) as RawProject[];

// Map entries to a simpler shape and attach id
const mapped: Project[] = all.map((e) => ({
  id: e.id,
  title: e.data.title ?? '',
  description: e.data.description ?? '',
  href: e.data.href ?? '#',
  tags: (e.data.tags ?? []) as string[],
  featured: !!e.data.featured,
  highlightOrder: typeof e.data.highlightOrder === 'number' ? e.data.highlightOrder : 9999,
}));

// Only include featured projects in highlights. Non-featured projects are
// treated as "others" but will only be rendered when `showAll` is true.
const highlights: Project[] = mapped.filter((p) => p.featured).sort((a, b) => a.highlightOrder - b.highlightOrder);
const others: Project[] = mapped.filter((p) => !p.featured).slice(0, limit);

---

<section class="projects">
  <div class="projects__inner">
    <div class="projects__header">
      <h2>Projects</h2>
      <p class="projects__lead">These are some projects I've recently built.</p>
    </div>

    {highlights.length > 0 && (
      <div class="projects__highlights">
        {highlights.map((p) => (
          <ProjectCard project={p} highlight={true} />
        ))}
      </div>
    )}

    {showAll && (
      <div class="projects__grid">
        {others.map((p) => (
          <ProjectCard project={p} />
        ))}
      </div>
    )}
    {!showAll && (
      <div class="projects__cta">
        <a class="btn btn--ghost" href="/projects" data-umami-event="home_view_all_projects">
          Browse all projects â†’
        </a>
      </div>
    )}
  </div>

</section>

<style>
  .projects { padding: 0.6rem 0.75rem 1.5rem; }
  .projects__inner { max-width: 860px; margin: 0 auto; padding-top: 0.25rem; }
  .projects__header { text-align: left; margin-bottom: .85rem; }
  .projects__header h2 { margin: 0 0 .25rem 0; }
  .projects__lead { color: rgb(var(--gray-dark)); margin: 0 0 0.6rem 0; max-width: 60ch; }

  /* Highlights: two-column on medium+, stack on small */
  .projects__highlights {
    display: grid;
    grid-template-columns: 1fr;
    gap: .5rem;
    margin-bottom: .75rem;
  }

  @media (min-width: 640px) {
    .projects__highlights { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  .projects__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: .5rem;
  }

  /* CTA row */
  .projects__cta {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
  }

  @media (max-width: 640px) {
    .projects__header { text-align: center; }
    .projects__cta .btn { width: 100%; max-width: 460px; text-align: center; justify-content: center; }
  }
</style>
